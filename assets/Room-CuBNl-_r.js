import{d as p,a as b,h as W,f as Y,s as y,c as H,g as T}from"./firebaseConfig-BxjB4Upe.js";import{d as Z,h as G,r as f,i as A,j as J,a as c,o as L,c as O,g as k,t as S,b as n,w as i,e as $,k as Q,u as X}from"./index-D52xPFLW.js";import{_ as ee,i as ae}from"./SelectModal.vue_vue_type_script_setup_true_lang-Dml34RE5.js";const te={class:"w-10/12 max-w-sm mt-28 mx-auto text-center"},oe={class:"text-3xl"},le={class:"flex gap-2 flex-wrap mt-2 justify-center"},ne="/Mystery-of-Antiques-bg",me=Z({__name:"Room",setup(se){const w=Q(),q=X(),C=G(),s=f();s.value=w.params.roomId;const x=p(b,"rooms",s.value),g=f(!1),v=f(),z=f(1),R=f(0),F=[{label:"老朝奉",value:"LaoChaofeng"},{label:"藥不然",value:"MedicineIsNot"},{label:"鄭國渠",value:"ZhengGuoqu"},{label:"許願",value:"MakeAWish"},{label:"方震",value:"FangZhen"},{label:"姬雲浮",value:"JiYunfu"},{label:"木戶加奈",value:"KidoKana"},{label:"黃煙煙",value:"HuangYanyan"}],V=["KidoKana","HuangYanyan"],t=f({...{name:null,character:null}}),B={name:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()},character:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()}},h=A(()=>w.query.host==="1"),I=h.value,j=A(()=>h.value?"開始遊戲":"加入遊戲"),N=async()=>{try{const a=H(x,"animals"),e=await T(a),o=[];e.forEach(m=>{const u=m.data(),l={name:u.animal,value:u.value,view_value:u.view_value};o.push(l)}),console.log(o),v.value=o}catch{}},D=async()=>{for(let a=1;a<=3;a++)try{const e=v.value.filter(r=>r.value===1),o=v.value.filter(r=>r.value===0),m=M(e,2),u=M(o,2),l=E([...m,...u]);for(const r of l)await y(p(x,`ReadomAnimalForRound${a}`,String(z.value++)),r);console.log(l),a===1&&C.success(`第一回合的動物${l[0].name}，${l[1].name}，${l[2].name}，${l[3].name}`,{closable:!0,duration:0}),v.value=v.value.filter(r=>!l.some(_=>_.name===r.name))}catch{}},M=(a,e)=>a.sort(()=>.5-Math.random()).slice(0,e),E=a=>{for(let e=a.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1));[a[e],a[o]]=[a[o],a[e]]}return a},K=()=>Math.floor(Math.random()*3)+1,P=async()=>{try{const a=p(b,"rooms",s.value),e={name:t.value.name,character:t.value.character,host:h.value,remain:1,myTurn:0,attacked:0,isCheckAble:1,isSkillAble:1,inActiveRound:V.includes(t.value.character)?K():0};h.value?(await y(p(a,"players",t.value.name),e),await ae(b,"rooms","roomId",s.value,"currentRound",1),await N(),await D(),R.value=1,g.value=!0):(await y(p(a,"players",t.value.name),e),q.push({path:`${ne}/game/${s.value}`,query:{host:h.value?1:0,player:t.value.name}}))}catch{}};return J(async()=>{try{s.value&&I&&!R.value&&(await W(Y,"deleteRoomWithSubcollections")({roomId:s.value}),console.log(`房間 ${s.value} 已成功刪除。`))}catch(a){console.error("Error deleting room: ",a)}}),(a,e)=>{const o=c("n-input"),m=c("n-form-item"),u=c("n-select"),l=c("n-form"),r=c("n-card"),_=c("n-button"),U=c("router-link");return L(),O("div",te,[k("p",oe,"房號："+S(s.value),1),n(r,{"header-style":"font-size: 32px",title:"玩家資料",class:"mt-8"},{default:i(()=>[n(l,{class:"text-center",ref:"basicFormRef","require-mark-placement":"left",rules:B,model:t.value},{default:i(()=>[n(m,{path:"name",label:"玩家暱稱","label-style":"font-size: 24px"},{default:i(()=>[n(o,{size:"large",class:"w-full text-xl","show-button":!1,value:t.value.name,"onUpdate:value":e[0]||(e[0]=d=>t.value.name=d),placeholder:"請填參與玩家都知道的暱稱"},null,8,["value"])]),_:1}),n(m,{path:"character",label:"角色","label-style":"font-size: 24px"},{default:i(()=>[n(u,{size:"large",class:"w-full custom-select-font-size",value:t.value.character,"onUpdate:value":e[1]||(e[1]=d=>t.value.character=d),options:F,placeholder:"選取抽到的角色"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1}),k("section",le,[n(U,{to:"/Mystery-of-Antiques-bg/"},{default:i(()=>[n(_,{class:"text-2xl",size:"large"},{default:i(()=>[$("返回")]),_:1})]),_:1}),n(_,{class:"text-2xl",size:"large",type:"primary",onClick:e[2]||(e[2]=d=>P())},{default:i(()=>[$(S(j.value),1)]),_:1})]),n(ee,{showModal:g.value,"onUpdate:showModal":e[3]||(e[3]=d=>g.value=d),name:t.value.name},null,8,["showModal","name"])])}}});export{me as default};

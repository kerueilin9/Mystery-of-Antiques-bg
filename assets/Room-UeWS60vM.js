import{d as p,a as w,h as O,f as Z,s as R,r as G,b as J,e as Q,o as X,i as ee,j as ae,c as te,g as oe}from"./firebaseConfig-BR434puB.js";import{d as le,h as ne,r as i,i as S,j as se,k as re,a as m,o as ue,c as ce,g as y,t as x,b as r,w as d,e as I,l as ie,u as me}from"./index-_-8Mi2D0.js";import{i as de,a as V}from"./setFirebaseData-DDiyQXTP.js";import{_ as ve}from"./SelectModal.vue_vue_type_script_setup_true_lang-B2qqjrLA.js";const fe={class:"w-10/12 max-w-sm text-center mt-8"},he={class:"text-3xl"},pe={class:"mt-28"},_e={class:"flex gap-2 flex-wrap mt-2 justify-center"},ge={class:"text-2xl mt-16"},ye="/Mystery-of-Antiques-bg",Ae=le({__name:"Room",setup(be){const M=ie(),z=me(),B=ne(),l=i();l.value=M.params.roomId;const k=p(w,"rooms",l.value),b=i(!1),f=i(),F=i(1),A=i(0),C=i(0),q=i(null),_=i(!1),j=[{label:"老朝奉",value:"LaoChaofeng"},{label:"藥不然",value:"MedicineIsNot"},{label:"鄭國渠",value:"ZhengGuoqu"},{label:"許願",value:"MakeAWish"},{label:"方震",value:"FangZhen"},{label:"姬雲浮",value:"JiYunfu"},{label:"木戶加奈",value:"KidoKana"},{label:"黃煙煙",value:"HuangYanyan"}],D=["KidoKana","HuangYanyan"],n=i({...{name:null,character:null}}),E={name:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()},character:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()}},h=S(()=>M.query.host==="1"),K=h.value,N=S(()=>h.value?"開始遊戲":"加入遊戲"),P=async()=>{try{const a=te(k,"animals"),e=await oe(a),t=[];e.forEach(u=>{const s=u.data(),o={name:s.animal,value:s.value,view_value:s.view_value};t.push(o)}),console.log(t),f.value=t}catch{}},T=async()=>{for(let a=1;a<=3;a++)try{const e=f.value.filter(c=>c.value===1),t=f.value.filter(c=>c.value===0),u=$(e,2),s=$(t,2),o=U([...u,...s]);for(const c of o)await R(p(k,`ReadomAnimalForRound${a}`,String(F.value++)),c);console.log(o),a===1&&B.success(`第一回合的動物為 ${o[0].name}，${o[1].name}，${o[2].name}，${o[3].name}`,{closable:!0,duration:0}),f.value=f.value.filter(c=>!o.some(g=>g.name===c.name))}catch{}},$=(a,e)=>a.sort(()=>.5-Math.random()).slice(0,e),U=a=>{for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a},W=()=>Math.floor(Math.random()*3)+1,Y=async()=>{try{await q.value.validate(),_.value=!0;const a=p(w,"rooms",l.value),e={name:n.value.name,character:n.value.character,host:h.value,remain:1,myTurn:0,attacked:0,isCheckAble:1,isSkillAble:1,inActiveRound:D.includes(n.value.character)?W():0,record:{round1:[],round2:[],round3:[]}};h.value?(await R(p(a,"players",n.value.name),e),await de(w,"rooms","roomId",l.value,"currentRound",1),await V(l.value,"currentRound",1),await P(),await T(),A.value=1,b.value=!0,_.value=!1):(await R(p(a,"players",n.value.name),e),await V(l.value,"playerCount",1),_.value=!1,z.push({path:`${ye}/game/${l.value}`,query:{host:h.value?1:0,player:n.value.name}}))}catch(a){console.log(a)}},H=async a=>{try{const e=G(J,"rooms"),t=Q(e,X("roomId"),ee(a));ae(t,async u=>{if(u.exists()){const s=u.val(),o=Object.keys(s)[0];C.value=s[o].playerCount||0}else console.log("roomId not found")})}catch(e){console.error("Error querying roomId",e)}};return se(async()=>{await H(l.value)}),re(async()=>{try{l.value&&K&&!A.value&&(await O(Z,"deleteRoomWithSubcollections")({roomId:l.value}),console.log(`房間 ${l.value} 已成功刪除。`))}catch(a){console.error("Error deleting room: ",a)}}),(a,e)=>{const t=m("n-input"),u=m("n-form-item"),s=m("n-select"),o=m("n-form"),c=m("n-card"),g=m("n-button"),L=m("router-link");return ue(),ce("div",fe,[y("p",he,"房號："+x(l.value),1),y("div",pe,[r(c,{"header-style":"font-size: 32px",title:"玩家資料"},{default:d(()=>[r(o,{class:"text-center",ref_key:"basicFormRef",ref:q,"require-mark-placement":"left",rules:E,model:n.value},{default:d(()=>[r(u,{path:"name",label:"玩家暱稱","label-style":"font-size: 24px"},{default:d(()=>[r(t,{size:"large",class:"w-full text-xl","show-button":!1,value:n.value.name,"onUpdate:value":e[0]||(e[0]=v=>n.value.name=v),placeholder:"請填參與玩家都知道的暱稱"},null,8,["value"])]),_:1}),r(u,{path:"character",label:"角色","label-style":"font-size: 24px"},{default:d(()=>[r(s,{size:"large",class:"w-full custom-select-font-size",value:n.value.character,"onUpdate:value":e[1]||(e[1]=v=>n.value.character=v),options:j,placeholder:"選取抽到的角色"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1}),y("section",_e,[r(L,{to:"/Mystery-of-Antiques-bg/"},{default:d(()=>[r(g,{class:"text-2xl",size:"large"},{default:d(()=>[I("返回")]),_:1})]),_:1}),r(g,{loading:_.value,class:"text-2xl",size:"large",type:"primary",onClick:e[2]||(e[2]=v=>Y())},{default:d(()=>[I(x(N.value),1)]),_:1},8,["loading"])]),y("div",ge,"房內人數："+x(C.value),1)]),r(ve,{showModal:b.value,"onUpdate:showModal":e[3]||(e[3]=v=>b.value=v),name:n.value.name},null,8,["showModal","name"])])}}});export{Ae as default};

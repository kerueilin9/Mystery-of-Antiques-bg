import{d as p,a as w,h as L,f as O,s as x,r as Z,b as G,e as J,o as Q,i as X,j as ee,c as ae,g as te}from"./firebaseConfig-BR434puB.js";import{d as oe,h as le,r as i,i as $,j as ne,k as se,a as m,o as re,c as ue,g as y,t as R,b as r,w as d,e as S,l as ce,u as ie}from"./index-CYwT95dm.js";import{i as me,a as I}from"./setFirebaseData-DDiyQXTP.js";import{_ as de}from"./SelectModal.vue_vue_type_script_setup_true_lang-BdPCHhMf.js";const ve={class:"w-10/12 max-w-sm text-center mt-8"},fe={class:"text-3xl"},he={class:"mt-28"},pe={class:"flex gap-2 flex-wrap mt-2 justify-center"},_e={class:"text-2xl mt-16"},ge="/Mystery-of-Antiques-bg",Ae=oe({__name:"Room",setup(ye){const M=ce(),V=ie(),z=le(),l=i();l.value=M.params.roomId;const A=p(w,"rooms",l.value),b=i(!1),f=i(),B=i(1),C=i(0),k=i(0),_=i(!1),j=[{label:"老朝奉",value:"LaoChaofeng"},{label:"藥不然",value:"MedicineIsNot"},{label:"鄭國渠",value:"ZhengGuoqu"},{label:"許願",value:"MakeAWish"},{label:"方震",value:"FangZhen"},{label:"姬雲浮",value:"JiYunfu"},{label:"木戶加奈",value:"KidoKana"},{label:"黃煙煙",value:"HuangYanyan"}],F=["KidoKana","HuangYanyan"],n=i({...{name:null,character:null}}),D={name:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()},character:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()}},h=$(()=>M.query.host==="1"),E=h.value,K=$(()=>h.value?"開始遊戲":"加入遊戲"),N=async()=>{try{const a=ae(A,"animals"),e=await te(a),t=[];e.forEach(u=>{const s=u.data(),o={name:s.animal,value:s.value,view_value:s.view_value};t.push(o)}),console.log(t),f.value=t}catch{}},P=async()=>{for(let a=1;a<=3;a++)try{const e=f.value.filter(c=>c.value===1),t=f.value.filter(c=>c.value===0),u=q(e,2),s=q(t,2),o=T([...u,...s]);for(const c of o)await x(p(A,`ReadomAnimalForRound${a}`,String(B.value++)),c);console.log(o),a===1&&z.success(`第一回合的動物為 ${o[0].name}，${o[1].name}，${o[2].name}，${o[3].name}`,{closable:!0,duration:0}),f.value=f.value.filter(c=>!o.some(g=>g.name===c.name))}catch{}},q=(a,e)=>a.sort(()=>.5-Math.random()).slice(0,e),T=a=>{for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a},U=()=>Math.floor(Math.random()*3)+1,W=async()=>{try{_.value=!0;const a=p(w,"rooms",l.value),e={name:n.value.name,character:n.value.character,host:h.value,remain:1,myTurn:0,attacked:0,isCheckAble:1,isSkillAble:1,inActiveRound:F.includes(n.value.character)?U():0,record:{round1:[],round2:[],round3:[]}};h.value?(await x(p(a,"players",n.value.name),e),await me(w,"rooms","roomId",l.value,"currentRound",1),await I(l.value,"currentRound",1),await N(),await P(),C.value=1,b.value=!0,_.value=!1):(await x(p(a,"players",n.value.name),e),await I(l.value,"playerCount",1),_.value=!1,V.push({path:`${ge}/game/${l.value}`,query:{host:h.value?1:0,player:n.value.name}}))}catch(a){console.log(a)}},Y=async a=>{try{const e=Z(G,"rooms"),t=J(e,Q("roomId"),X(a));ee(t,async u=>{if(u.exists()){const s=u.val(),o=Object.keys(s)[0];k.value=s[o].playerCount||0}else console.log("roomId not found")})}catch(e){console.error("Error querying roomId",e)}};return ne(async()=>{await Y(l.value)}),se(async()=>{try{l.value&&E&&!C.value&&(await L(O,"deleteRoomWithSubcollections")({roomId:l.value}),console.log(`房間 ${l.value} 已成功刪除。`))}catch(a){console.error("Error deleting room: ",a)}}),(a,e)=>{const t=m("n-input"),u=m("n-form-item"),s=m("n-select"),o=m("n-form"),c=m("n-card"),g=m("n-button"),H=m("router-link");return re(),ue("div",ve,[y("p",fe,"房號："+R(l.value),1),y("div",he,[r(c,{"header-style":"font-size: 32px",title:"玩家資料"},{default:d(()=>[r(o,{class:"text-center",ref:"basicFormRef","require-mark-placement":"left",rules:D,model:n.value},{default:d(()=>[r(u,{path:"name",label:"玩家暱稱","label-style":"font-size: 24px"},{default:d(()=>[r(t,{size:"large",class:"w-full text-xl","show-button":!1,value:n.value.name,"onUpdate:value":e[0]||(e[0]=v=>n.value.name=v),placeholder:"請填參與玩家都知道的暱稱"},null,8,["value"])]),_:1}),r(u,{path:"character",label:"角色","label-style":"font-size: 24px"},{default:d(()=>[r(s,{size:"large",class:"w-full custom-select-font-size",value:n.value.character,"onUpdate:value":e[1]||(e[1]=v=>n.value.character=v),options:j,placeholder:"選取抽到的角色"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1}),y("section",pe,[r(H,{to:"/Mystery-of-Antiques-bg/"},{default:d(()=>[r(g,{class:"text-2xl",size:"large"},{default:d(()=>[S("返回")]),_:1})]),_:1}),r(g,{loading:_.value,class:"text-2xl",size:"large",type:"primary",onClick:e[2]||(e[2]=v=>W())},{default:d(()=>[S(R(K.value),1)]),_:1},8,["loading"])]),y("div",_e,"房內人數："+R(k.value),1)]),r(de,{showModal:b.value,"onUpdate:showModal":e[3]||(e[3]=v=>b.value=v),name:n.value.name},null,8,["showModal","name"])])}}});export{Ae as default};

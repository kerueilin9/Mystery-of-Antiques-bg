import{d as p,a as b,h as H,f as O,s as w,r as Z,b as G,e as J,o as L,i as Q,j as X,c as ee,g as ae}from"./firebaseConfig-BR434puB.js";import{d as te,h as oe,r as i,i as q,j as le,k as ne,a as m,o as se,c as re,g,t as x,b as r,w as d,e as $,l as ue,u as ce}from"./index-CY8F9pBZ.js";import{i as ie,a as S}from"./setFirebaseData-DDiyQXTP.js";import{_ as me}from"./SelectModal.vue_vue_type_script_setup_true_lang-DfRMAvKb.js";const de={class:"w-10/12 max-w-sm text-center mt-8"},ve={class:"text-3xl"},fe={class:"mt-28"},he={class:"flex gap-2 flex-wrap mt-2 justify-center"},pe={class:"text-2xl mt-16"},_e="/Mystery-of-Antiques-bg",Me=te({__name:"Room",setup(ge){const R=ue(),I=ce(),V=oe(),l=i();l.value=R.params.roomId;const M=p(b,"rooms",l.value),y=i(!1),f=i(),z=i(1),A=i(0),C=i(0),B=[{label:"老朝奉",value:"LaoChaofeng"},{label:"藥不然",value:"MedicineIsNot"},{label:"鄭國渠",value:"ZhengGuoqu"},{label:"許願",value:"MakeAWish"},{label:"方震",value:"FangZhen"},{label:"姬雲浮",value:"JiYunfu"},{label:"木戶加奈",value:"KidoKana"},{label:"黃煙煙",value:"HuangYanyan"}],j=["KidoKana","HuangYanyan"],n=i({...{name:null,character:null}}),F={name:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()},character:{required:!0,trigger:["blur","input","change"],type:"string",validator:(a,e)=>e==null||e===""?Promise.reject("必填"):Promise.resolve()}},h=q(()=>R.query.host==="1"),D=h.value,E=q(()=>h.value?"開始遊戲":"加入遊戲"),K=async()=>{try{const a=ee(M,"animals"),e=await ae(a),t=[];e.forEach(u=>{const s=u.data(),o={name:s.animal,value:s.value,view_value:s.view_value};t.push(o)}),console.log(t),f.value=t}catch{}},N=async()=>{for(let a=1;a<=3;a++)try{const e=f.value.filter(c=>c.value===1),t=f.value.filter(c=>c.value===0),u=k(e,2),s=k(t,2),o=P([...u,...s]);for(const c of o)await w(p(M,`ReadomAnimalForRound${a}`,String(z.value++)),c);console.log(o),a===1&&V.success(`第一回合的動物為 ${o[0].name}，${o[1].name}，${o[2].name}，${o[3].name}`,{closable:!0,duration:0}),f.value=f.value.filter(c=>!o.some(_=>_.name===c.name))}catch{}},k=(a,e)=>a.sort(()=>.5-Math.random()).slice(0,e),P=a=>{for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a},T=()=>Math.floor(Math.random()*3)+1,U=async()=>{try{const a=p(b,"rooms",l.value),e={name:n.value.name,character:n.value.character,host:h.value,remain:1,myTurn:0,attacked:0,isCheckAble:1,isSkillAble:1,inActiveRound:j.includes(n.value.character)?T():0,record:{round1:[],round2:[],round3:[]}};h.value?(await w(p(a,"players",n.value.name),e),await ie(b,"rooms","roomId",l.value,"currentRound",1),await S(l.value,"currentRound",1),await K(),await N(),A.value=1,y.value=!0):(await w(p(a,"players",n.value.name),e),await S(l.value,"playerCount",1),I.push({path:`${_e}/game/${l.value}`,query:{host:h.value?1:0,player:n.value.name}}))}catch(a){console.log(a)}},W=async a=>{try{const e=Z(G,"rooms"),t=J(e,L("roomId"),Q(a));X(t,async u=>{if(u.exists()){const s=u.val(),o=Object.keys(s)[0];C.value=s[o].playerCount||0}else console.log("roomId not found")})}catch(e){console.error("Error querying roomId",e)}};return le(async()=>{await W(l.value)}),ne(async()=>{try{l.value&&D&&!A.value&&(await H(O,"deleteRoomWithSubcollections")({roomId:l.value}),console.log(`房間 ${l.value} 已成功刪除。`))}catch(a){console.error("Error deleting room: ",a)}}),(a,e)=>{const t=m("n-input"),u=m("n-form-item"),s=m("n-select"),o=m("n-form"),c=m("n-card"),_=m("n-button"),Y=m("router-link");return se(),re("div",de,[g("p",ve,"房號："+x(l.value),1),g("div",fe,[r(c,{"header-style":"font-size: 32px",title:"玩家資料"},{default:d(()=>[r(o,{class:"text-center",ref:"basicFormRef","require-mark-placement":"left",rules:F,model:n.value},{default:d(()=>[r(u,{path:"name",label:"玩家暱稱","label-style":"font-size: 24px"},{default:d(()=>[r(t,{size:"large",class:"w-full text-xl","show-button":!1,value:n.value.name,"onUpdate:value":e[0]||(e[0]=v=>n.value.name=v),placeholder:"請填參與玩家都知道的暱稱"},null,8,["value"])]),_:1}),r(u,{path:"character",label:"角色","label-style":"font-size: 24px"},{default:d(()=>[r(s,{size:"large",class:"w-full custom-select-font-size",value:n.value.character,"onUpdate:value":e[1]||(e[1]=v=>n.value.character=v),options:B,placeholder:"選取抽到的角色"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1}),g("section",he,[r(Y,{to:"/Mystery-of-Antiques-bg/"},{default:d(()=>[r(_,{class:"text-2xl",size:"large"},{default:d(()=>[$("返回")]),_:1})]),_:1}),r(_,{class:"text-2xl",size:"large",type:"primary",onClick:e[2]||(e[2]=v=>U())},{default:d(()=>[$(x(E.value),1)]),_:1})]),g("div",pe,"房內人數："+x(C.value),1)]),r(me,{showModal:y.value,"onUpdate:showModal":e[3]||(e[3]=v=>y.value=v),name:n.value.name},null,8,["showModal","name"])])}}});export{Me as default};
